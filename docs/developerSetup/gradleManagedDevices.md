# Gradle managed devices within the project

Within the [build logic Gradle project], there exists a custom gradle plugin that allows the project
to [test with Gradle managed devices]. This is different to other methods, such as the `connected`
family of instrumentation test tasks by utilising a setup task to start the emulator, then running
the relevant instrumentation tests for a given project.

It's expected for managed devices to replace the need for specific GitHub actions that load up an
emulator, as it's instead handled by gradle instead of through various Android Virtual Device (AVD)
or Android Debug Bridge (ADB) commands.

The [BaseExtension kotlin extension functions] generate device names, with the ability
to override the extra properties declared within the [emulator configuration plugin] should there be
a need for changing devices, Android API levels as well as the system image used as a baseline.
Look into Android Studio's `Gradle` tool window within the `${module}/Tasks/verification` for
applicable tasks generated by this [emulator configuration plugin].

Refer to the [Running the app and tests within the code base] tutorial for running the
instrumentation tests via a Gradle managed device.

## Gotchas

### Hardware rendering

When running Gradle managed device tasks on systems that don't support hardware rendering, it's
important to redefine the emulator's GPU as part of the command being ran to `swiftshader_indirect`.
Please see the proceeding example for the property to pass in:

```shell
./gradlew googleApisPlaystorePixelXLApi29DebugAndroidTest \
-Pandroid.testoptions.manageddevices.emulator.gpu=swiftshader_indirect
```

### Concurrency issues

Be mindful of potential issues with task graph configurations relating to managed devices.
The setup tasks for a given managed device don't lock the launched emulator like the `connected`
family of instrumentation test tasks, meaning that running multiple setup tasks across gradle
workers may fail. To mitigate this, run the gradle task with only 1 worker:

```shell
./gradlew googleApisPlaystorePixelXLApi30DebugAndroidTest --max-workers=1
```


[BaseExtension extension functions]: /modules/buildLogic/plugins/src/main/kotlin/uk/gov/documentchecking/extensions/BaseExtensions.kt
[build logic Gradle project]: /modules/buildLogic/plugins
[emulator configuration plugin]: /modules/buildLogic/plugins/src/main/kotlin/uk/gov/documentchecking/emulator-config.gradle.kts
[Running the app and tests within the code base]: ./runningTheCodeBase.md
[test with Gradle managed devices]: https://developer.android.com/studio/test/gradle-managed-devices
