name: 'Run gradle check'
description: 'Run the "check" command for a Gradle project'

inputs:
  architecture:
    description: 'AVD architecture to use'
    required: false
    default: 'x86_64'
  device-profile:
    description: 'AVD device profile to use'
    required: false
    default: 'pixel_5'
  locale:
    description: 'Locale used within the emulator'
    required: false
    default: 'en-GB'
  version-code:
    description: 'Version code'
    required: true
  version-name:
    description: 'Version name'
    required: true
  shard-count:
    default: 3
    description: 'The number of Gradle managed devices to run at once for larger test suites'
    required: true

runs:
  using: "composite"
  steps:
    - name: Stop all emulators
      run: |
        .sh/stopAllEmulators.sh
      shell: bash

    - name: Set up Gradle managed devices
      env:
        INPUT_VERSION_CODE: ${{ inputs.version-code }}
        INPUT_VERSION_NAME: ${{ inputs.version-name }}
      run: |
        ./gradlew \
        googleAtdPixelXLApi30Setup \
        --continue \
        --max-workers=1 \
        --stacktrace \
        -Pandroid.testoptions.manageddevices.emulator.gpu=swiftshader_indirect \
        -PversionCode=${INPUT_VERSION_CODE} \
        -PversionName=${INPUT_VERSION_NAME} \
      shell: bash

    - name: Run larger Gradle managed device test suites
      env:
        INPUT_SHARD_COUNT: ${{ inputs.shard-count }}
        INPUT_VERSION_CODE: ${{ inputs.version-code }}
        INPUT_VERSION_NAME: ${{ inputs.version-name }}
      run: |
        ./gradlew \
        :app:googleAtdPixelXLApi30BuildDebugAndroidTest \
        :modules:network:api:googleAtdPixelXLApi30BuildDebugAndroidTest \
        :modules:repositories:impl:googleAtdPixelXLApi30BuildDebugAndroidTest \
        :modules:ui:components:googleAtdPixelXLApi30DebugAndroidTest \
        :modules:ui:presentation:googleAtdPixelXLApi30BuildDebugAndroidTest \
        --continue \
        --max-workers=1 \
        --stacktrace \
        -Pandroid.testoptions.manageddevices.emulator.gpu=swiftshader_indirect \
        -PversionCode=${INPUT_VERSION_CODE} \
        -PversionName=${INPUT_VERSION_NAME} \
      shell: bash

    - name: Run smaller Gradle managed device test suites
      env:
        INPUT_VERSION_CODE: ${{ inputs.version-code }}
        INPUT_VERSION_NAME: ${{ inputs.version-name }}
      run: |
        ./gradlew \
        :modules:features:api:googleAtdPixelXLApi30BuildDebugAndroidTest \
        :modules:iproov:api:googleAtdPixelXLApi30BuildDebugAndroidTest \
        :modules:iproov:impl:googleAtdPixelXLApi30BuildDebugAndroidTest \
        :modules:iproov:testdouble:googleAtdPixelXLApi30BuildDebugAndroidTest \
        :modules:logging:api:googleAtdPixelXLApi30BuildDebugAndroidTest \
        :modules:logging:impl:googleAtdPixelXLApi30BuildDebugAndroidTest \
        :modules:logging:testdouble:googleAtdPixelXLApi30BuildDebugAndroidTest \
        :modules:network:impl:googleAtdPixelXLApi30BuildDebugAndroidTest \
        :modules:network:testdouble:googleAtdPixelXLApi30BuildDebugAndroidTest \
        :modules:readid:common:api:googleAtdPixelXLApi30BuildDebugAndroidTest \
        :modules:readid:common:impl:googleAtdPixelXLApi30BuildDebugAndroidTest \
        :modules:readid:common:testdouble:googleAtdPixelXLApi30BuildDebugAndroidTest \
        :modules:readid:translations:googleAtdPixelXLApi30DebugAndroidTest \
        :modules:repositories:api:googleAtdPixelXLApi30DebugAndroidTest \
        :modules:testingFramework:instrumentation:googleAtdPixelXLApi30BuildDebugAndroidTest \
        :modules:ui:pages:googleAtdPixelXLApi30DebugAndroidTest \
        :modules:ui:theme:googleAtdPixelXLApi30DebugAndroidTest \
        --continue \
        --max-workers=1 \
        --stacktrace \
        -Pandroid.testoptions.manageddevices.emulator.gpu=swiftshader_indirect \
        -PversionCode=${INPUT_VERSION_CODE} \
        -PversionName=${INPUT_VERSION_NAME} \
      shell: bash
